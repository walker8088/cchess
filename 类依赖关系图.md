# cchess 类依赖关系图

```mermaid
classDiagram
    %% 核心类
    class ChessBoard {
        -_board: Piece[][]
        -move_player: ChessPlayer
        +from_fen(fen)
        +to_fen()
        +move(p_from, p_to)
        +move_iccs(iccs)
        +get_piece(pos)
        +is_checking()
        +is_checkmate()
    }
    
    class ChessPlayer {
        +color: int
        +next()
        +opposite()
    }
    
    class Piece {
        +board: ChessBoard
        +fench: str
        +species: int
        +color: int
        +x, y: int
        +is_valid_pos(pos)
        +is_valid_move(pos_to)
        +create(board, fench, pos)$
    }
    
    class King {
        +is_valid_pos(pos)
        +is_valid_move(pos_to)
    }
    
    class Advisor {
        +is_valid_pos(pos)
        +is_valid_move(pos_to)
    }
    
    class Bishop {
        +is_valid_pos(pos)
        +is_valid_move(pos_to)
    }
    
    class Knight {
        +is_valid_move(pos_to)
    }
    
    class Rook {
        +is_valid_move(pos_to)
    }
    
    class Cannon {
        +is_valid_move(pos_to)
    }
    
    class Pawn {
        +is_valid_move(pos_to)
    }
    
    class Move {
        +board: ChessBoard
        +p_from: tuple
        +p_to: tuple
        +is_checking: bool
        +is_checkmate: bool
        +captured: str
        +next_move: Move
        +branchs: list
        +to_text()
        +to_iccs()
    }
    
    class Game {
        +init_board: ChessBoard
        +first_move: Move
        +last_move: Move
        +info: dict
        +annote: str
        +read_from(file_name)$
        +save_to(file_name)
        +print_text_moves()
    }
    
    %% 异常类
    class CChessException {
        +reason: str
    }
    
    class EngineErrorException {
        +reason: str
    }
    
    %% 引擎相关类
    class EngineStatus {
        <<enumeration>>
        ERROR
        BOOTING
        READY
        WAITING
        INFO_MOVE
        MOVE
        DEAD
    }
    
    class Engine {
        <<Thread>>
        +engine_exec_path: str
        +engine_status: EngineStatus
        +process: subprocess.Popen
        +move_queue: Queue
        +load(engine_path)
        +go_from(fen, params)
        +get_action()
        +wait_for_ready()
        +quit()
    }
    
    class UcciEngine {
        +init_cmd()
        +ok_resp()
    }
    
    class UciEngine {
        +init_cmd()
        +ok_resp()
    }
    
    class FenCache {
        +fen_dict: dict
        +cache_file: str
        +get(fen)
        +save_action(fen, action)
        +load(cache_file)
        +save()
    }
    
    class EngineManager {
        +engine: Engine
        +cache: FenCache
        +load_uci(engine_exec, options, go_params)
        +load_ucci(engine_exec, options, go_params)
        +get_best_cache(fen)
        +run_engine(fen)
    }
    
    %% IO相关类
    class XQFKey {
        +KeyXYf: int
        +KeyXYt: int
    }
    
    class XQFBuffDecoder {
        +buff: bytes
        +read_bytes(n)
        +read_int()
    }
    
    class XQMove {
        +step_index: int
        +has_variation: bool
    }
    
    class XQFWriter {
        +write(game, file_name)
    }
    
    class PGNParser {
        +parse(file_name)
    }
    
    class PGNWriter {
        +write(game, file_name)
    }
    
    class CbrBuffDecoder {
        +buff: bytes
        +read_bytes(n)
    }
    
    %% Demo类
    class GameTable {
        +screen: pygame.Surface
        +board: ChessBoard
        +engine: list
        +selected: tuple
        +new_game(title, fen)
        +draw()
        +run_once()
    }
    
    class GameKeeper {
        +file: str
        +games: list
        +games_done: list
        +load()
        +done(index)
        +next(index)
    }
    
    %% 继承关系
    Piece <|-- King
    Piece <|-- Advisor
    Piece <|-- Bishop
    Piece <|-- Knight
    Piece <|-- Rook
    Piece <|-- Cannon
    Piece <|-- Pawn
    
    Exception <|-- CChessException
    Exception <|-- EngineErrorException
    
    Thread <|-- Engine
    Engine <|-- UcciEngine
    Engine <|-- UciEngine
    
    ChessBoard <|-- ChessBoardOneHot
    
    %% 组合/依赖关系
    ChessBoard *-- ChessPlayer : contains
    ChessBoard *-- Piece : contains
    ChessBoard ..> Move : creates
    
    Piece --> ChessBoard : uses
    
    Move --> ChessBoard : contains
    Move *-- Move : next_move
    
    Game *-- ChessBoard : init_board
    Game *-- Move : first_move
    
    Engine --> ChessBoard : uses
    Engine --> Game : uses
    Engine --> EngineErrorException : raises
    
    EngineManager *-- Engine : manages
    EngineManager *-- FenCache : uses
    
    FenCache --> ChessBoard : uses
    
    GameTable *-- ChessBoard : uses
    GameTable --> Game : uses
    GameTable --> Engine : uses
    
    GameKeeper --> Game : manages
    
    %% IO依赖
    XQFWriter --> Game : writes
    PGNParser --> Game : creates
    PGNWriter --> Game : writes
```

## 类依赖关系说明

### 核心类层次
1. **ChessBoard（棋盘）**: 核心类，包含棋盘状态和所有棋子
   - 依赖: Piece, Move, ChessPlayer
   
2. **Piece（棋子）**: 抽象基类，所有棋子的父类
   - 依赖: ChessBoard
   - 子类: King, Advisor, Bishop, Knight, Rook, Cannon, Pawn
   
3. **Move（走子）**: 表示一步棋
   - 依赖: ChessBoard
   - 自引用: next_move, branchs（变招）
   
4. **Game（棋局）**: 管理整个棋局，包括初始棋盘和所有走子
   - 依赖: ChessBoard, Move

### 引擎系统
1. **Engine（引擎基类）**: 抽象引擎接口
   - 继承自 Thread
   - 依赖: ChessBoard, Game
   
2. **UcciEngine / UciEngine**: 具体引擎实现
   - 继承自 Engine
   
3. **EngineManager（引擎管理器）**: 管理引擎和缓存
   - 组合: Engine, FenCache
   
4. **FenCache（FEN缓存）**: 缓存棋局评估结果
   - 依赖: ChessBoard

### IO系统
- **XQFWriter / PGNWriter**: 写入棋谱文件
- **PGNParser**: 解析PGN文件
- 都依赖 Game 类

### Demo应用
- **GameTable**: 游戏界面，使用pygame
  - 依赖: ChessBoard, Game, Engine
- **GameKeeper**: 管理多个棋局
  - 依赖: Game

### 异常类
- **CChessException**: 通用异常
- **EngineErrorException**: 引擎相关异常

